/*
Deployment script for Util

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "Util"
:setvar DefaultFilePrefix "Util"
:setvar DefaultDataPath "D:\Data\SQLServer\MSSQL12.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "D:\Data\SQLServer\MSSQL12.MSSQLSERVER\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [master];


GO

IF (DB_ID(N'$(DatabaseName)') IS NOT NULL) 
BEGIN
    ALTER DATABASE [$(DatabaseName)]
    SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
    DROP DATABASE [$(DatabaseName)];
END

GO
PRINT N'Creating $(DatabaseName)...'
GO
CREATE DATABASE [$(DatabaseName)]
    ON 
    PRIMARY(NAME = [$(DatabaseName)], FILENAME = N'$(DefaultDataPath)$(DefaultFilePrefix)_Primary.mdf')
    LOG ON (NAME = [$(DatabaseName)_log], FILENAME = N'$(DefaultLogPath)$(DefaultFilePrefix)_Primary.ldf') COLLATE SQL_Latin1_General_CP1_CI_AS
GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ANSI_NULLS ON,
                ANSI_PADDING ON,
                ANSI_WARNINGS ON,
                ARITHABORT ON,
                CONCAT_NULL_YIELDS_NULL ON,
                NUMERIC_ROUNDABORT OFF,
                QUOTED_IDENTIFIER ON,
                ANSI_NULL_DEFAULT ON,
                CURSOR_DEFAULT LOCAL,
                RECOVERY FULL,
                CURSOR_CLOSE_ON_COMMIT OFF,
                AUTO_CREATE_STATISTICS ON,
                AUTO_SHRINK OFF,
                AUTO_UPDATE_STATISTICS ON,
                RECURSIVE_TRIGGERS OFF 
            WITH ROLLBACK IMMEDIATE;
        ALTER DATABASE [$(DatabaseName)]
            SET AUTO_CLOSE OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ALLOW_SNAPSHOT_ISOLATION OFF;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET READ_COMMITTED_SNAPSHOT OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET AUTO_UPDATE_STATISTICS_ASYNC OFF,
                PAGE_VERIFY NONE,
                DATE_CORRELATION_OPTIMIZATION OFF,
                DISABLE_BROKER,
                PARAMETERIZATION SIMPLE,
                SUPPLEMENTAL_LOGGING OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF IS_SRVROLEMEMBER(N'sysadmin') = 1
    BEGIN
        IF EXISTS (SELECT 1
                   FROM   [master].[dbo].[sysdatabases]
                   WHERE  [name] = N'$(DatabaseName)')
            BEGIN
                EXECUTE sp_executesql N'ALTER DATABASE [$(DatabaseName)]
    SET TRUSTWORTHY OFF,
        DB_CHAINING OFF 
    WITH ROLLBACK IMMEDIATE';
            END
    END
ELSE
    BEGIN
        PRINT N'The database settings cannot be modified. You must be a SysAdmin to apply these settings.';
    END


GO
IF IS_SRVROLEMEMBER(N'sysadmin') = 1
    BEGIN
        IF EXISTS (SELECT 1
                   FROM   [master].[dbo].[sysdatabases]
                   WHERE  [name] = N'$(DatabaseName)')
            BEGIN
                EXECUTE sp_executesql N'ALTER DATABASE [$(DatabaseName)]
    SET HONOR_BROKER_PRIORITY OFF 
    WITH ROLLBACK IMMEDIATE';
            END
    END
ELSE
    BEGIN
        PRINT N'The database settings cannot be modified. You must be a SysAdmin to apply these settings.';
    END


GO
ALTER DATABASE [$(DatabaseName)]
    SET TARGET_RECOVERY_TIME = 0 SECONDS 
    WITH ROLLBACK IMMEDIATE;


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET FILESTREAM(NON_TRANSACTED_ACCESS = OFF),
                CONTAINMENT = NONE 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET AUTO_CREATE_STATISTICS ON(INCREMENTAL = OFF),
                MEMORY_OPTIMIZED_ELEVATE_TO_SNAPSHOT = OFF,
                DELAYED_DURABILITY = DISABLED 
            WITH ROLLBACK IMMEDIATE;
    END


GO
USE [$(DatabaseName)];


GO
IF fulltextserviceproperty(N'IsFulltextInstalled') = 1
    EXECUTE sp_fulltext_database 'enable';


GO
PRINT N'Creating [Logging]...';


GO
CREATE SCHEMA [Logging]
    AUTHORIZATION [dbo];


GO
PRINT N'Creating [Util.Logging]...';


GO
CREATE ASSEMBLY [Util.Logging]
    AUTHORIZATION [dbo]
    FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010300415187580000000000000000E00002210B010B00000C000000060000000000003E2B0000002000000040000000000010002000000002000004000000000000000600000000000000008000000002000000000000030060850000100000100000000010000010000000000000100000000000000000000000F02A00004B00000000400000B802000000000000000000000000000000000000006000000C000000B82900001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000440B000000200000000C000000020000000000000000000000000000200000602E72737263000000B80200000040000000040000000E0000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001200000000000000000000000000004000004200000000000000000000000000000000202B0000000000004800000002000500682200005007000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001B300200ED01000001000011007201000070730500000A0A00730600000A0B72310000701E730700000A0C72490000701E730700000A0D725D0000701E730700000A1304727D0000701F19730700000A130572870000701F0C730700000A130672990000701E730700000A130772B50000701F0C730700000A130872D500007018730700000A130972E300007018730700000A130A720D01007018730700000A130B08028C020000016F0800000A0009038C020000016F0800000A001104048C020000016F0800000A001105056F0800000A0011060E046F0800000A0011070E058C020000016F0800000A0011080E066F0800000A0011090E078C020000016F0800000A00110A0E098C0E0000016F0800000A00110B0E0A8C0E0000016F0800000A00076F0900000A086F0A00000A26076F0900000A096F0A00000A26076F0900000A11046F0A00000A26076F0900000A11056F0A00000A26076F0900000A11066F0A00000A26076F0900000A11076F0A00000A26076F0900000A11086F0A00000A26076F0900000A11096F0A00000A26076F0900000A110A6F0A00000A26076F0900000A110B6F0A00000A260772290100706F0B00000A00071A6F0C00000A0007066F0D00000A00066F0E00000A0007130C110C6F0F00000A26066F1000000A0000DE120614FE01130D110D2D07066F1100000A00DC002A000000411C0000020000000C000000CD010000D9010000120000000000000042534A4201000100000000000C00000076342E302E33303331390000000005006C000000E8010000237E000054020000F002000023537472696E677300000000440500004C0100002355530090060000100000002347554944000000A0060000B000000023426C6F620000000000000002000001471502000900000000FA253300160000010000001300000002000000010000000B000000110000000400000001000000010000000200000000000A0001000000000006003C0035000A0064004F000A006D004F0006000901F60013001D0100000600520132010600720132010A00B8019D010A00E401CE010A00F201CE010A00FD01CE010A000A0243000A002702140206003D0235000A004502CE010A006F0214020A00890243000A00B40214020600DC0235000000000001000000000001000100810110001B000000050001000100502000000000960074000A000100000001007B00000002008600000003008F00000004009E0000000500A20000000600AA0000000700B70000000800C60000000900CC0000000A00D50000000B00E90021002C011F0031002C01250039002C012A0041002C012A0049002C01330051002C012A0059002C013800690033023F0051005C02440079006B0249008100790233008100950250005100A50256009100C1022A008100C6025C009100D6022A009900E8022A00200023002E002E000B007E002E00130087002E001B00900060000480000000000000000000000000000000009001000004000000000000000000000001002C000000000004000000000000000000000001004300000000000000003C4D6F64756C653E005574696C2E4C6F6767696E672E646C6C0053746F72656450726F63656475726573006D73636F726C69620053797374656D004F626A6563740053797374656D2E446174610053797374656D2E446174612E53716C54797065730053716C496E7433320053716C586D6C00434C524C6F670044617461626173654944004F626A656374496400506172656E744F626A656374496400546167004C6F675479706500526F77734166666563746564004164646974696F6E616C496E666F004C6F67496400496E66657254616200496E666572506172656E744F626A656374496400496E6665724C61737453514C0053797374656D2E446961676E6F73746963730044656275676761626C6541747472696275746500446562756767696E674D6F646573002E63746F720053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465005574696C2E4C6F6767696E67004D6963726F736F66742E53716C5365727665722E5365727665720053716C50726F6365647572654174747269627574650053797374656D2E446174612E53716C436C69656E740053716C436F6E6E656374696F6E0053716C436F6D6D616E640053716C506172616D657465720053716C4462547970650053797374656D2E446174612E436F6D6D6F6E004462506172616D65746572007365745F56616C756500426F6F6C65616E0053716C506172616D65746572436F6C6C656374696F6E006765745F506172616D657465727300416464004462436F6D6D616E64007365745F436F6D6D616E645465787400436F6D6D616E6454797065007365745F436F6D6D616E6454797065007365745F436F6E6E656374696F6E004462436F6E6E656374696F6E004F70656E00457865637574654E6F6E517565727900436C6F73650049446973706F7361626C6500446973706F736500002F63006F006E007400650078007400200063006F006E006E0065006300740069006F006E003D007400720075006500001740004400610074006100620061007300650049006400001340004F0062006A0065006300740049006400001F400050006100720065006E0074004F0062006A006500630074004900640000094000540061006700001140004C006F0067005400790070006500001B400052006F007700730041006600660065006300740065006400001F40004100640064006900740069006F006E0061006C0049006E0066006F00000D40004C006F006700490064000029400049006E0066006500720050006100720065006E0074004F0062006A0065006300740049006400001B400049006E006600650072004C00610073007400530051004C0000214C006F006700670069006E0067002E00530074006100720074004C006F0067000000EF45AB9A8D3A994A8A2B8F24AA8FEDEC0008B77A5C561934E08914000B01110911091109120D0E11090E11090202020520010111150420010108032000010401000000042001010E062002010E1131042001011C042000123D062001122D122D052001011145052001011225032000081D070E12251229122D122D122D122D122D122D122D122D122D122D1229020801000701000000000801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F77730100000000004151875800000000020000001C010000D4290000D40B000052534453D566CE90A42C8D4089E6FA7A5013A10401000000643A5C50726573656E746174696F6E5C323031375C5453514C5F4C6F6767696E675C5574696C2E4C6F6767696E675C5574696C2E4C6F6767696E675C6F626A5C44656275675C5574696C2E4C6F6767696E672E706462000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000182B000000000000000000002E2B0000002000000000000000000000000000000000000000000000202B00000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF25002000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000005C02000000000000000000005C0234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004BC010000010053007400720069006E006700460069006C00650049006E0066006F0000009801000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E003000000044001100010049006E007400650072006E0061006C004E0061006D00650000005500740069006C002E004C006F006700670069006E0067002E0064006C006C00000000002800020001004C006500670061006C0043006F0070007900720069006700680074000000200000004C00110001004F0072006900670069006E0061006C00460069006C0065006E0061006D00650000005500740069006C002E004C006F006700670069006E0067002E0064006C006C0000000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E00300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000403B00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000;


GO
ALTER ASSEMBLY [Util.Logging]
    DROP FILE ALL
    ADD FILE FROM 0x4D6963726F736F667420432F432B2B204D534620372E30300D0A1A44530000000002000002000000170000007C0000000000000016000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000C0FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF380080FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0BCA3101380000000010000000100000000000000E00FFFF04000000FFFF03000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000BCA3101380000000010000000100000000000000F00FFFF04000000FFFF0300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000942E31014151875801000000D566CE90A42C8D4089E6FA7A5013A10400000000000000000100000001000000000000000000000000000000DC51330100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000BCA310138000000001000000010000000000000FFFFFFFF04000000FFFF030000000000FFFFFFFF00000000FFFFFFFF00000000FFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000BCA310138000000001000000010000000000000FFFFFFFF04000000FFFF030000000000FFFFFFFF00000000FFFFFFFF00000000FFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F862513FC607D311905300C04FA302A1C4454B99E9E6D211903F00C04FA302A10B9D865A1166D311BD2A0000F80849BD60A66E40CF64824CB6F042D48172A79910000000000000006F4666D90378884C33DEA042B1A79AC7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ED01000000000000ED010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FEEFFEEF01000000C200000000643A5C50726573656E746174696F6E5C323031375C5453514C5F4C6F6767696E675C5574696C2E4C6F6767696E675C5574696C2E4C6F6767696E675C4C6F6767696E675C53746F7265642050726F636564757265735C434C524C6F672E63730000643A5C70726573656E746174696F6E5C323031375C7473716C5F6C6F6767696E675C7574696C2E6C6F6767696E675C7574696C2E6C6F6767696E675C6C6F6767696E675C73746F7265642070726F636564757265735C636C726C6F672E6373000400000061000000000000000100000062000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001BE2300180000000A93DA2A14276D201010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000200000001000000010000000000000062000000280000001BE23001B770489F58000000010000006100000062000000650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000002E002A11000000004003000000000000ED010000000000000000000001000006000000000100000000434C524C6F670016000311040000000C030000ED01000000000000010000000A0024115553797374656D00120024115553797374656D2E44617461000000001A0024115553797374656D2E446174612E53716C436C69656E7400001A0024115553797374656D2E446174612E53716C54797065730000001E002411554D6963726F736F66742E53716C5365727665722E536572766572000E0024115553797374656D2E586D6C001E0020110D000000010000110000000000000400435324342430303030000000160003113400000008030000EB01000001000000010000001E00201100000000010000110000000000000000636F6E6E656374696F6E000016000311F400000004030000CB0100000C000000010000002600201101000000010000110000000000000000496E736572744C6F67436F6D6D616E6400000000220020110200000001000011000000000000000044617461626173654944506172616D0022002011030000000100001100000000000000004F626A6563744964506172616D0000002600201104000000010000110000000000000000506172656E744F626A6563744964506172616D001E00201105000000010000110000000000000000546167506172616D0000000022002011060000000100001100000000000000004C6F6754797065506172616D000000002600201107000000010000110000000000000000526F77734166666563746564506172616D00000026002011080000000100001100000000000000004164646974696F6E616C496E666F506172616D001E002011090000000100001100000000000000004C6F674964506172616D00002E0020110A000000010000110000000000000000496E666572506172656E744F626A6563744964506172616D00000000260020110B000000010000110000000000000000496E6665724C61737453514C506172616D0000001A0020110C000000010000110000000000000000636F6D6D616E64000200060002000600020006002E000404C93FEAC6B359D649BC250902BBABB460000000004D0044003200000004010000040000000C0000000100060002000600F2000000340200000000000001000100ED010000000000002D00000028020000000000000D000080010000000E0000800C0000000F0000800D0000001000008013000000110000801F000000120000802B0000001300008038000000140000804600000015000080540000001600008061000000170000806F000000180000807C00000019000080890000001A000080960000001D000080A30000001E000080B00000001F000080BE00000020000080C700000021000080D100000022000080E000000023000080EA00000024000080F900000025000080080100002600008017010000280000802401000029000080310100002A0000803F0100002B0000804D0100002C0000805B0100002D000080690100002E000080770100002F00008085010000300000809301000031000080A101000033000080AD01000034000080B501000035000080BD01000038000080C401000039000080C70100003A000080CF0100003B000080D60100003C000080D7010000EEEFFE80EB010000EEEFFE80EC0100003D000080050006001000570009000A000D003C000D005B000D0057000D0063000D004D000D005A000D005F000D0068000D0051000D006D000D005E000D0030000D002C000D0038000D0022000D002A000D0034000D0038000D0026000D0042000D0034000D003E000D003C000D0042000D0037000D003B000D0040000D0042000D0039000D0047000D0040000D003F000D0048000D0036000D001F000D0033000D0027000D00200009000A00000000000000000005000600F400000008000000010000000000000008000000000000001800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFF1A092FF1100000000C02000019000000010000000100000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001600251100000000040000000100434C524C6F6700000000160029110000000004000000010030363030303030310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000FFFFFFFF1A092FF10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFF77093101010000000B00008E0C000E040D0000005C000000200000002C0000006C000000000000000000000016000000190000000000EEC00000000000000000FFFF000000000000FFFFFFFF00000000FFFF0000000000000000000000000A0044030000000000004C0200000100000050E17601000000000000000053746F72656450726F636564757265730043444135313336460000002DBA2EF10100000000000000ED01000000000000000000000000000000000000020002000D01000000000100FFFFFFFF00000000ED0100000802000000000000FFFFFFFF00000000FFFFFFFF010001000000010000000000643A5C50726573656E746174696F6E5C323031375C5453514C5F4C6F6767696E675C5574696C2E4C6F6767696E675C5574696C2E4C6F6767696E675C4C6F6767696E675C53746F7265642050726F636564757265735C434C524C6F672E637300FEEFFEEF010000000100000000010000000000000000000000FFFFFFFFFFFFFFFFFFFF0900FFFFFFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000942E31014151875801000000D566CE90A42C8D4089E6FA7A5013A1048D0000002F4C696E6B496E666F002F6E616D6573002F7372632F686561646572626C6F636B002F7372632F66696C65732F643A5C70726573656E746174696F6E5C323031375C7473716C5F6C6F6767696E675C7574696C2E6C6F6767696E675C7574696C2E6C6F6767696E675C6C6F6767696E675C73746F7265642070726F636564757265735C636C726C6F672E6373000400000006000000010000001B00000000000000220000000800000011000000070000000A00000006000000000000000500000000000000DC5133010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E00000020000000E900000038000000830100003800000000000000E60000008000000058000000280000009C0500002C0200002C0000003000000003000000140000000600000013000000070000000A0000000B00000008000000090000000C0000000D0000000E0000000F000000100000001200000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 AS N'Util.Logging.pdb';


GO
PRINT N'Creating [Logging].[Log]...';


GO
CREATE TABLE [Logging].[Log] (
    [LogId]                BIGINT           IDENTITY (1, 1) NOT NULL,
    [LogDate]              DATETIME2 (7)    NOT NULL,
    [ServerName]           [sysname]        NOT NULL,
    [SPID]                 INT              NOT NULL,
    [ConnectionId]         UNIQUEIDENTIFIER NOT NULL,
    [DatabaseName]         NVARCHAR (400)   NULL,
    [AppContextInfo]       VARCHAR (128)    NULL,
    [Tag]                  XML              NULL,
    [ObjectID]             INT              NULL,
    [ParentObjectID]       INT              NULL,
    [LogType]              NVARCHAR (20)    NOT NULL,
    [ObjectName]           NVARCHAR (400)   NULL,
    [ParentObjectName]     NVARCHAR (400)   NULL,
    [EndDateTime]          DATETIME2 (7)    NULL,
    [RowsAffected]         INT              NULL,
    [ErrorLine]            INT              NULL,
    [ErrorMessage]         NVARCHAR (MAX)   NULL,
    [AdditionalInfo]       NVARCHAR (MAX)   NULL,
    [DurationMilliseconds] AS               (datediff(millisecond, [LogDate], [EndDateTime])),
    [Status]               AS               (CASE WHEN [EndDateTime] IS NULL THEN 'Running' WHEN [ErrorMessage] IS NOT NULL THEN 'Error' ELSE 'Complete' END),
    [TransactionCount]     INT              NULL,
    [LastSQL]              VARCHAR (MAX)    NULL,
    PRIMARY KEY CLUSTERED ([LogId] ASC)
);


GO
PRINT N'Creating [Logging].[Log].[ncx_Log_ObjectId]...';


GO
CREATE NONCLUSTERED INDEX [ncx_Log_ObjectId]
    ON [Logging].[Log]([ObjectID] ASC);


GO
PRINT N'Creating [Logging].[Log].[ncx_Log_LogDate]...';


GO
CREATE NONCLUSTERED INDEX [ncx_Log_LogDate]
    ON [Logging].[Log]([LogDate] ASC);


GO
PRINT N'Creating [Logging].[LogAppMaster]...';


GO
CREATE TABLE [Logging].[LogAppMaster] (
    [AppContextInfo]      VARCHAR (128) NOT NULL,
    [IsOn]                BIT           NOT NULL,
    [LogAutonomously]     BIT           NOT NULL,
    [InferTag]            BIT           NOT NULL,
    [InferParentObjectId] BIT           NOT NULL,
    [InferLastSQL]        BIT           NOT NULL,
    [InferError]          BIT           NOT NULL,
    [PrintMessages]       BIT           NOT NULL,
    CONSTRAINT [PK_LogAppMaster] PRIMARY KEY CLUSTERED ([AppContextInfo] ASC)
);


GO
PRINT N'Creating [dbo].[Log]...';


GO
CREATE SYNONYM [dbo].[Log] FOR [Logging].[Log];


GO
PRINT N'Creating unnamed constraint on [Logging].[Log]...';


GO
ALTER TABLE [Logging].[Log]
    ADD DEFAULT (getdate()) FOR [LogDate];


GO
PRINT N'Creating unnamed constraint on [Logging].[Log]...';


GO
ALTER TABLE [Logging].[Log]
    ADD DEFAULT (@@servername) FOR [ServerName];


GO
PRINT N'Creating unnamed constraint on [Logging].[Log]...';


GO
ALTER TABLE [Logging].[Log]
    ADD DEFAULT (@@spid) FOR [SPID];


GO
PRINT N'Creating unnamed constraint on [Logging].[Log]...';


GO
ALTER TABLE [Logging].[Log]
    ADD DEFAULT (db_name(db_id())) FOR [DatabaseName];


GO
PRINT N'Creating unnamed constraint on [Logging].[Log]...';


GO
ALTER TABLE [Logging].[Log]
    ADD DEFAULT ('PROCEDURE') FOR [LogType];


GO
PRINT N'Creating [Logging].[CK_Log]...';


GO
ALTER TABLE [Logging].[Log]
    ADD CONSTRAINT [CK_Log] CHECK ([LogType]='LOOP' OR [LogType]='PACKAGE' OR [LogType]='SQL' OR [LogType]='STEP' OR [LogType]='FUNCTION' OR [LogType]='PROCEDURE' OR [LogType]='MODULE' OR [LogType]='APPLICATION' OR [LogType]='PROCESS' OR [LogType]='BATCH' OR [LogType]='ANONYMOUS BLOCK');


GO
PRINT N'Creating [dbo].[DeleteAllAttributes]...';


GO
CREATE SYNONYM [dbo].[DeleteAllAttributes] FOR [Logging].[DeleteAllAttributes];


GO
PRINT N'Creating [dbo].[DeleteAttribute]...';


GO
CREATE SYNONYM [dbo].[DeleteAttribute] FOR [Logging].[DeleteAttribute];


GO
PRINT N'Creating [dbo].[EndLog]...';


GO
CREATE SYNONYM [dbo].[EndLog] FOR [Logging].[EndLog];


GO
PRINT N'Creating [dbo].[GetAttribute]...';


GO
CREATE SYNONYM [dbo].[GetAttribute] FOR [Logging].[GetAttribute];


GO
PRINT N'Creating [dbo].[SetAttribute]...';


GO
CREATE SYNONYM [dbo].[SetAttribute] FOR [Logging].[SetAttribute];


GO
PRINT N'Creating [dbo].[ShowAllAttributes]...';


GO
CREATE SYNONYM [dbo].[ShowAllAttributes] FOR [Logging].[ShowAllAttributes];


GO
PRINT N'Creating [dbo].[StartLog]...';


GO
CREATE SYNONYM [dbo].[StartLog] FOR [Logging].[StartLog];


GO
PRINT N'Creating [Logging].[vwActiveLoggingSessions]...';


GO
 
CREATE VIEW Logging.vwActiveLoggingSessions
AS
SELECT
    --CAST(CONTEXT_INFO() AS VARCHAR(128)) AppContextInfo,
    (SELECT TOP 1 AppContextInfo FROM Log WHERE ConnectionId = ec.connection_id) AppContextInfo,
    ec.*
FROM
    master.sys.dm_exec_connections ec
WHERE
    EXISTS
        (
            SELECT 1
            FROM Log l
            WHERE l.ConnectionId = ec.connection_id
        );
GO
PRINT N'Creating [Logging].[vwLogOfActiveSessions]...';


GO
 
CREATE VIEW Logging.vwLogOfActiveSessions
AS
SELECT
    ec.session_id, ec.connect_time, ec.num_reads, ec.num_writes, ec.last_read, ec.last_write, ec.most_recent_sql_handle,
    l.*
FROM
    Log l
        INNER JOIN master.sys.dm_exec_connections ec
            ON l.ConnectionId = ec.connection_id
GO
PRINT N'Creating [Logging].[vwLogSummaryByLogType]...';


GO
 
CREATE VIEW Logging.vwLogSummaryByLogType
AS
SELECT
    DatabaseName,
    LogType,
    AppContextInfo,
    COUNT(DISTINCT ObjectId) DistinctCount,
    COUNT(1) Executions,
    MIN(LogDate) OldestLog,
    MAX(LogDate) NewestLog,
    SUM(DurationMilliSeconds) TotalExecutionMilliSecs,
    MIN(DurationMilliSeconds) FastestExecutionMilliSecs,
    MAX(DurationMilliSeconds) SlowestExecutionMilliSecs,
    AVG(DurationMilliSeconds) AvgExecutionMilliSecs
FROM Log
GROUP BY
    DatabaseName,
    LogType,
    AppContextInfo;
GO
PRINT N'Creating [Logging].[vwLogSummaryByStep]...';


GO
 
CREATE VIEW Logging.vwLogSummaryByStep
AS
SELECT
    DatabaseName,
    LogType,
    AppContextInfo,
    AdditionalInfo,
    COUNT(1) Executions,
    MIN(LogDate) OldestLog,
    MAX(LogDate) NewestLog,
    MIN(DurationMilliSeconds) FastestExecutionMilliSecs,
    MAX(DurationMilliSeconds) SlowestExecutionMilliSecs,
    AVG(DurationMilliSeconds) AvgExecutionMilliSecs
FROM Log
GROUP BY
    DatabaseName,
    LogType,
    AppContextInfo,
    AdditionalInfo;
GO
PRINT N'Creating [Logging].[vwLogOfActiveSessionLatestEntry]...';


GO
 
CREATE VIEW Logging.vwLogOfActiveSessionLatestEntry
AS
SELECT l.*
FROM
    Log l INNER JOIN
        (
            --Get the latest log by log type for each active connection
            SELECT  MAX(LogId) LogId
            FROM Logging.vwLogOfActiveSessions
            GROUP BY ConnectionId, LogType
         ) latest
    ON l.LogId = latest.LogId;
GO
PRINT N'Creating [Logging].[SetAttribute]...';


GO
 
CREATE PROCEDURE Logging.SetAttribute
    @AttributeName  VARCHAR(100),
    @AttributeValue SQL_VARIANT,
    @AttributeType VARCHAR(25) = 'VARCHAR',         --For convenience only. Conversion is your responsibility.
    @AttributeFormat VARCHAR(100) = NULL                --For convenience only. E.g., store date format
AS
BEGIN
 
-- =============================================================================================
-- Created By: Jana Sattainathan
-- Create date: Apr 09, 2015
-- Description: Procedure that sets the current value of certain attributes that can be fetched later in other procedures.
--                  Typically used when information cannot be passed into called sub-programs that operate independently but values need to be shared.
--                  Please see the information in GetAttribute
-- Usage:
/*
    ---------------
    --Example 1
    ---------------
        Logging.SetAttribute @AttributeName='TEST', @AttributeValue='DAFSFASFSA', @AttributeType='VARCHAR', @AttributeFormat=NULL;
        SELECT * FROM ##TempAttributesTable;
 
*/
-- ================================================================================================
 
    --Create a temp table to hold the values
    IF object_id('TEMPDB.DBO.##TempAttributesTable') IS NULL
    BEGIN
        CREATE TABLE ##TempAttributesTable
            (
                [ConnectionId] UNIQUEIDENTIFIER NOT NULL,
                [Name]  VARCHAR(100) NOT NULL,
                [Value] SQL_VARIANT,
                [Type] VARCHAR(25),
                [Format]  VARCHAR(100),
                [At] DATETIME2 NOT NULL DEFAULT CURRENT_TIMESTAMP
            );
    END;
 
    DECLARE @ConnectionId UNIQUEIDENTIFIER = (
                    SELECT Connection_Id
                    FROM sys.dm_exec_connections
                    WHERE session_id = @@SPID
                    );
 
    --Insert/Update based on whether the attribute exists
    IF EXISTS (
                SELECT *
                FROM ##TempAttributesTable
                WHERE
                    ConnectionId = @ConnectionId
                    AND Name = @AttributeName
            )
    BEGIN
        UPDATE ##TempAttributesTable
        SET
            [Value] = @AttributeValue,
            [Type] = @AttributeType,
            [Format] = @AttributeFormat
        WHERE
            [ConnectionId] = @ConnectionId
            AND [Name] = @AttributeName;
    END
    ELSE
    BEGIN
        INSERT INTO ##TempAttributesTable ([ConnectionId], [Name], [Value], [Type], [Format])
        VALUES (@ConnectionId, @AttributeName, @AttributeValue, @AttributeType, @AttributeFormat);
    END
 
    --PRINT CONVERT(VARCHAR,GETDATE()) + ': Set ' + @AttributeName + ' attribute';
END;
GO
PRINT N'Creating [Logging].[GetAttribute]...';


GO
 
CREATE PROCEDURE Logging.GetAttribute
    @AttributeName  VARCHAR(100),
    @AttributeValue SQL_VARIANT OUTPUT,
    @AttributeType VARCHAR(25) OUTPUT,          --For convenience only. Conversion is your responsibility.
    @AttributeFormat VARCHAR(100) OUTPUT,       --For convenience only. E.g., store date format
    @IgnoreIfAttributeIsMissing BIT = 0         --When set to 1, returns NULL's if attributes asked for dont exist
AS
BEGIN
 
-- =============================================================================================
-- Created By: Jana Sattainathan
-- Create date: Apr 09, 2015
-- Description: Procedure that gets the current value of certain attributes that were possibly set in other procedures in this session.
--                  Typically used in conjuction with SetAttribute when information cannot be passed into called sub-programs that operate independently but values need to be shared.
--                  Set attribute values and in the calling proc and used them in called procs with GetAttribute.
-- Usage:
/*
    ---------------
    --Example 1 - Set and Get a simple string that happens to be XML. Need to do conversion yourself. Notice SQL_VARIANT to VARCHAR(200) conversion for @AttributeValue
    ---------------
 
        --Set some attribute in Procedure A.
        -----------------------------------
        DECLARE @Tag VARCHAR(200)= '<TestApplication> ' +
                                        '<ProcessName>Test process</ProcessName>' +
                                        '<LogId>1214</LogId>' +
                                        '<RunNumber>22</RunNumber>' +
                                    '</TestApplication>';
        EXEC Logging.SetAttribute @AttributeName='Tag', @AttributeValue=@Tag, @AttributeType='XML', @AttributeFormat=NULL;
 
        EXEC Logging.ShowAllAttributes;
 
        --Get the value of that attribute in Procedure B
        -----------------------------------
        DECLARE @AttributeName  VARCHAR(100) = 'Tag';
        DECLARE @AttributeValue SQL_VARIANT;
        DECLARE @AttributeType VARCHAR(25);
        DECLARE @AttributeFormat VARCHAR(100);
 
        EXEC Logging.GetAttribute @AttributeName='Tag', @AttributeValue=@AttributeValue OUTPUT, @AttributeType=@AttributeType OUTPUT, @AttributeFormat=@AttributeFormat OUTPUT, @IgnoreIfAttributeIsMissing=1
 
        PRINT @AttributeName;
        PRINT CONVERT(VARCHAR(200), @AttributeValue);
        PRINT @AttributeType;
        PRINT @AttributeFormat;
 
    ---------------
    --Example 1 - Set and Get a simple string but ignore things like type, format etc that we dont care about
    ---------------
 
        --Set some attribute
        -----------------------------------
        DECLARE @Tag VARCHAR(200)= '<TestApplication> ' +
                                        '<ProcessName>Test process</ProcessName>' +
                                        '<LogId>1214</LogId>' +
                                        '<RunNumber>22</RunNumber>' +
                                    '</TestApplication>';
        EXEC Logging.SetAttribute @AttributeName='Log.Tag', @AttributeValue=@Tag, @AttributeType='XML', @AttributeFormat=NULL;
 
        EXEC Logging.ShowAllAttributes;
 
        --Get the value of that attribute in another procedure
        -----------------------------------
        DECLARE @AttributeName  VARCHAR(100) = 'Log.Tag1';
        DECLARE @AttributeValue SQL_VARIANT;
        EXEC Logging.GetAttribute @AttributeName=@AttributeName, @AttributeValue=@AttributeValue OUTPUT, @AttributeType=NULL, @AttributeFormat=NULL, @IgnoreIfAttributeIsMissing=1
 
        PRINT @AttributeName;
        PRINT CONVERT(VARCHAR(200), @AttributeValue);
 
*/
--================================================================================================
    DECLARE @AttributeFetched BIT = 0;
 
    --Create a temp table to hold the values
    IF object_id('TEMPDB.DBO.##TempAttributesTable') IS NOT NULL
    BEGIN
        --Select values out of the global temp table for given attribute
        IF EXISTS (
                    SELECT *
                    FROM ##TempAttributesTable
                    WHERE Name = @AttributeName
                )
        BEGIN
            DECLARE @ConnectionId UNIQUEIDENTIFIER = (
                    SELECT Connection_Id
                    FROM sys.dm_exec_connections
                    WHERE session_id = @@SPID
                    );
 
            IF EXISTS(
                        SELECT *
                        FROM ##TempAttributesTable
                        WHERE
                            ConnectionId = @ConnectionId
                            AND [Name] = @AttributeName
                    )
            BEGIN
                SELECT
                    @AttributeValue = [Value],
                    @AttributeType = [Type],
                    @AttributeFormat = [Format]
                FROM ##TempAttributesTable
                WHERE
                    ConnectionId = @ConnectionId
                    AND [Name] = @AttributeName;
 
                SET @AttributeFetched = 1;
            END;
        END;
    END;
 
    --Raise an error if @IgnoreIfAttributeIsMissing = 0 and attribute to delete does not exist for whatever reason
    IF ((@AttributeFetched = 0) AND (@IgnoreIfAttributeIsMissing = 0))
    BEGIN
        -- RAISERROR with severity 11-19 will cause execution to jump to the CATCH block.
        DECLARE @Msg VARCHAR(200) = 'Attribute ' + @AttributeName + ' does not exist. Cannot get attribute value!'
        RAISERROR (@Msg, -- Message text.
                    16, -- Severity.
                    1 -- State.
                    );
    END;
    ELSE IF (@AttributeFetched = 0)
    BEGIN
        SET @AttributeValue = NULL;
        SET @AttributeType = NULL;
        SET @AttributeFormat = NULL;
    END;
 
    --PRINT CONVERT(VARCHAR,GETDATE()) + ': Get ' + @AttributeName + ' attribute';
END;
GO
PRINT N'Creating [Logging].[DeleteAttribute]...';


GO
 
CREATE PROCEDURE Logging.DeleteAttribute
    @AttributeName  VARCHAR(100),
    @IgnoreIfAttributeIsMissing BIT = 1
AS
BEGIN
 
-- =============================================================================================
-- Created By: Jana Sattainathan
-- Create date: Apr 09, 2015
-- Description: Procedure that deletes one of the attributes.
-- Usage:
/*
    ---------------
    --Example 1
    ---------------
 
        EXEC Logging.SetAttribute @AttributeName='TEST', @AttributeValue='Test value', @AttributeType='VARCHAR', @AttributeFormat=NULL;
 
        EXEC Logging.DeleteAttribute @AttributeName='TEST'
 
        EXEC Logging.ShowAllAttributes
 
*/
-- ================================================================================================
 
    DECLARE @AttributeDeleted BIT = 0;
 
    --Create a temp table to hold the values
    IF object_id('TEMPDB.DBO.##TempAttributesTable') IS NOT NULL
    BEGIN
 
        DECLARE @ConnectionId UNIQUEIDENTIFIER = (
                    SELECT Connection_Id
                    FROM sys.dm_exec_connections
                    WHERE session_id = @@SPID
                    );
 
        --Select values out of the global temp table for given attribute
        IF EXISTS (
                    SELECT *
                    FROM ##TempAttributesTable
                    WHERE
                        ConnectionId = @ConnectionId
                        AND Name = @AttributeName
                )
        BEGIN
 
            IF EXISTS(SELECT *
                        FROM ##TempAttributesTable
                        WHERE
                            ConnectionId = @ConnectionId
                            AND [Name] = @AttributeName)
            BEGIN
                DELETE
                FROM ##TempAttributesTable
                WHERE
                    ConnectionId = @ConnectionId
                    AND [Name] = @AttributeName;
 
                SET @AttributeDeleted = 1;
            END;
        END;
    END;
 
    --Raise an error if @IgnoreIfAttributeIsMissing = 0 and attribute to delete does not exist for whatever reason
    IF ((@AttributeDeleted = 0) AND (@IgnoreIfAttributeIsMissing = 0))
    BEGIN
        -- RAISERROR with severity 11-19 will cause execution to jump to the CATCH block.
        DECLARE @Msg VARCHAR(200) = 'Attribute ' + @AttributeName + ' does not exist. Cannot delete attribute!'
        RAISERROR (@Msg, -- Message text.
                    16, -- Severity.
                    1 -- State.
                    );
    END;
 
    PRINT CONVERT(VARCHAR,GETDATE()) + ': Delete ' + @AttributeName + ' attribute';
END;
GO
PRINT N'Creating [Logging].[ShowAllAttributes]...';


GO
 
CREATE PROCEDURE Logging.ShowAllAttributes
    @ShowGlobal BIT = 0                     --Show the attributes for everyone or just this connection
AS
BEGIN
 
-- =============================================================================================
-- Created By: Jana Sattainathan
-- Create date: Apr 09, 2015
-- Description: Procedure that shows all of the attributes.
-- Usage:
/*
    ---------------
    --Example 1 - Show all the attributes of current connection
    ---------------
 
        EXEC Logging.SetAttribute @AttributeName='TEST', @AttributeValue='Test value', @AttributeType='VARCHAR', @AttributeFormat=NULL;
 
        EXEC Logging.ShowAllAttributes
 
    ---------------
    --Example 2 - Show all the attributes of all connections
    ---------------
 
        EXEC Logging.SetAttribute @AttributeName='TEST', @AttributeValue='Test value', @AttributeType='VARCHAR', @AttributeFormat=NULL;
 
        EXEC Logging.ShowAllAttributes @ShowGlobal = 1
 
*/
-- ================================================================================================
 
    IF object_id('TEMPDB.DBO.##TempAttributesTable') IS NOT NULL
    BEGIN
 
        DECLARE @ConnectionId UNIQUEIDENTIFIER = (
                SELECT Connection_Id
                FROM sys.dm_exec_connections
                WHERE session_id = @@SPID
                );
 
        SELECT *
        FROM ##TempAttributesTable
        WHERE
            ConnectionId = CASE WHEN @ShowGlobal = 1
                                THEN ConnectionId
                                ELSE @ConnectionId
                            END;
    END
    ELSE
    BEGIN
        PRINT CONVERT(VARCHAR,GETDATE()) + ': No attributes exist. SetAttribute has never been called!';
    END;
END;
GO
PRINT N'Creating [Logging].[DeleteAllAttributes]...';


GO
 
CREATE PROCEDURE Logging.DeleteAllAttributes
AS
BEGIN
 
-- =============================================================================================
-- Created By: Jana Sattainathan
-- Create date: Apr 09, 2015
-- Description: Procedure that Deletes all of the attributes of current connection
-- Usage:
/*
    ---------------
    --Example 1 - Delete all the attributes of current connection
    ---------------
 
        EXEC Logging.SetAttribute @AttributeName='TEST', @AttributeValue='Test value', @AttributeType='VARCHAR', @AttributeFormat=NULL;
 
        EXEC Logging.DeleteAllAttributes
 
        EXEC Logging.ShowAllAttributes
*/
-- ================================================================================================
 
    IF object_id('TEMPDB.DBO.##TempAttributesTable') IS NOT NULL
    BEGIN
 
        DECLARE @ConnectionId UNIQUEIDENTIFIER = (
                SELECT Connection_Id
                FROM sys.dm_exec_connections
                WHERE session_id = @@SPID
                );
 
        DELETE
        FROM ##TempAttributesTable
        WHERE
            ConnectionId = @ConnectionId;
    END
    ELSE
    BEGIN
        PRINT CONVERT(VARCHAR,GETDATE()) + ': No attributes exist. SetAttribute has never been called!';
    END;
END;
GO
PRINT N'Creating [Logging].[StartLog]...';


GO
CREATE PROCEDURE [Logging].[StartLog]
    @DatabaseID BIGINT = NULL
    ,@ObjectID BIGINT = NULL
    ,@ParentObjectID BIGINT = NULL
    ,@Tag VARCHAR(MAX) = NULL				--XML not supported on linked server but data is XML data!
    ,@LogType NVARCHAR(20) = 'PROCEDURE'
    ,@RowsAffected INT = NULL
    ,@AdditionalInfo NVARCHAR(MAX) = NULL
    ,@LogID BIGINT = NULL OUTPUT 
    ---------------------------------------
	--Below parameters are needed for "loopback" calls (for logging inside transactions) or calls from another DB
	,@IsLoopback BIT = 0
	,@ServerName NVARCHAR(100) = @@SERVERNAME
	,@SPID INT = @@SPID
	,@ConnectionId UNIQUEIDENTIFIER = NULL
	,@ObjectName NVARCHAR(256) = NULL
	,@ParentObjectName NVARCHAR(256) = NULL
	,@ContextInfo VARBINARY(128) = NULL
	,@LastSQL VARCHAR(MAX) = NULL
	,@ErrorLine INT = NULL
	,@ErrorMessage NVARCHAR(4000) = NULL
	,@TranCount INT = NULL
AS
BEGIN

    -- =============================================================================================
    -- Original Idea By:    Aaron Bertrand
    -- Updated By: Jana Sattainathan [Twitter: @SQLJana] [Blog: sqljana.wordpress.com]
    --              Apr 06, 2014 - Added additional columns ServerName, SID, LogType, Tag, Duration etc
    --                           - Added additional procedure EndLog for tracking begin/end time by closing an existing log entry
    --              Mar 31, 2015 - ....plus a lot more. Take a look at the original link to see the differences
	--				Jan 18, 2017 - Tons of enhancements to support "Autonomous Logging"
    -- Original Reference:  
	--		http://www.mssqltips.com/sqlservertip/2003/simple-process-to-track-and-log-sql-server-stored-procedure-use/
    -- Create date: Apr 06, 2014
    -- Description: Procedure that logs procedure calls
    -- Additional Info:
	--		https://github.com/SQLJana/TSQL_Logger/blob/master/README.md
    --      https://sqljana.wordpress.com/2017/01/09/sql-server-tsql-code-logging-to-table/
    -- Usage:
    /*
 
    --++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 
    ---------------
    --Example 0 - A complete example. See the other examples below this example for simpler, step by step understanding
    ---------------
 
        --Drop and recreate if our temporary demo procedures already exist..we will call it later to illustrate
        -------------------------------------------------------------------------------------------------------------
 
        IF object_id('TEMPDB.DBO.#MainProc') IS NOT NULL
            DROP PROCEDURE #MainProc;
        GO
 
        CREATE PROCEDURE #MainProc
        AS
        BEGIN
            ------------------------ Begin: Logging related ------------------------
            --Setting context for application (Do this only once in the entry-point procedure for the whole application/batch)
            --  ***** W A R N I N G *****: DO NOT SET THIS IN EVERY PROCEDURE!!
 
            DECLARE @AppContextInfo VARBINARY(128) =  CAST('My Test Application' AS  VARBINARY(128))
 
            --This information will be associated with the session and will be accessible in SQL Server system views
            SET CONTEXT_INFO @AppContextInfo        
 
            DECLARE @Tag VARCHAR(512) = '<TestApplication> ' +
                                            '<ProcessName>Test process</ProcessName>' +
                                            '<ReportToDate><<REPORTTODATE>></ReportToDate>' +
                                            '<LogId><<LOGID>></LogId>' +
                                            '<RunNumber><<RUNNUMBER>></RunNumber>' +
                                        '</TestApplication>';
            DECLARE @CallerProcId BIGINT = @@PROCID;            
 
            EXEC Logging.SetAttribute @AttributeName='Log.ParentObjectId', @AttributeValue=@CallerProcId, @AttributeType='BIGINT', @AttributeFormat=NULL;
            ------------------------ End: Logging related ------------------------
 
            ------------------------ Begin: Tag ------------------------
            --Replace placeholders in the Tag
            SET @Tag = REPLACE(@Tag, '<<REPORTTODATE>>', CONVERT(VARCHAR,getdate()));
            SET @Tag = REPLACE(@Tag, '<<LOGID>>', 232121);
            --SET @Tag = REPLACE(@Tag, '<<RUNNUMBER>>', NEXT VALUE FOR MySchema.RunNumberSeq);      --MySchema.RunNumberSeq is a pre-defined sequence object
            SET @Tag = REPLACE(@Tag, '<<RUNNUMBER>>', 12);
 
            EXEC Logging.SetAttribute @AttributeName='Log.Tag', @AttributeValue=@Tag, @AttributeType='XML', @AttributeFormat=NULL;
            ------------------------ End: Tag ------------------------
 
            --Call chain 1: Say procedure A calls procedure B, B calls C and so on...as part of Batch process 1
            --Call chain 2: As part of Batch process 2, procedure Z could call procedure B, B calls C and so on...the same chain..
            --However the context is different for both call chains. Different context info should be set for each chain..
            --All log entries made as part of Chain 1 will have the same AppContextInfo in Log
            --...and all log entries made as part of Chain 2 will have a different AppContextInfo in Log even for steps that are common for both chains!
 
            --Pass the tag along to all called procedures...so that log entries will have associated information recorded...and it will be querable later
            --EXEC #LoggingTestProc @CallerTag = @Tag, @CallerProcId = @@PROCID;
 
            --Can forego passing tag and calling proc info and it will be inferred since we SetAttributes for Log.Tag and Log.ParentObjectId
            --      but the ParentObjectId will be this top level procedure for all called procedures in the call tree but it works!
            EXEC #LoggingTestProc
        END
        GO
 
        -------------------------------------------------------------------------------------------------------------
 
        IF object_id('TEMPDB.DBO.#LoggingTestProc') IS NOT NULL
            DROP PROCEDURE #LoggingTestProc;
        GO
 
        CREATE PROCEDURE #LoggingTestProc
        (
            @CallerTag VARCHAR(512) = NULL,
            @CallerProcId BIGINT = NULL
        )
        AS
        BEGIN
 
            ------------------------ Begin: Logging related ------------------------
            DECLARE @DBId BIGINT = DB_ID();
            DECLARE @ObjId BIGINT = @@PROCID
            DECLARE @ParentObjId BIGINT = @CallerProcId     --Set to NULL if no @CallerProcId parameter
            DECLARE @LogId BIGINT;
            DECLARE @Msg VARCHAR(255);
            DECLARE @StepLogId BIGINT;
            DECLARE @StepMsg VARCHAR(255);
            DECLARE @Tag VARCHAR(512) = @CallerTag;         --Set to NULL if no @CallerTag parameter
            ------------------------ End: Logging related ------------------------
 
            BEGIN TRY
                SET @Msg = 'Starting procedure that calculates distance to moon!'
                EXEC StartLog @DatabaseId = @DBId, @Tag = @Tag, @ObjectID = @ObjId, @ParentObjectId = @ParentObjId, @LogType = 'ANONYMOUS BLOCK', @AdditionalInfo = @Msg, @LogId = @LogId OUTPUT        --Log procedure start
 
                ---------------
                ----STEP 1 ----
                ---------------
                --Do something that produces an error
                BEGIN TRY
                    SET @StepMsg = 'Finding the center of gravity on moon'
                    EXEC StartLog @DatabaseId = @DBId, @Tag = @Tag, @ObjectID = @ObjId, @ParentObjectId = @ParentObjId, @LogType = 'STEP', @AdditionalInfo = @StepMsg, @LogId = @StepLogId OUTPUT       --Log step start
 
                    DECLARE @Test INT = 1/0;
 
                    EXEC EndLog @LogID = @StepLogId;    --Log step end
                END TRY
                BEGIN CATCH
                    --Error message is automatically captured in the record for current @StepLogId
                    EXEC EndLog @LogID = @StepLogId;
                END CATCH;
 
                ---------------
                ----STEP 2 ----
                ---------------
                --Do something that completes fine - run dynamic SQL
 
                DECLARE @SQL NVARCHAR(255) = 'select top 1 * from sys.tables'
 
                SET @StepMsg = @SQL
                EXEC StartLog @DatabaseId = @DBId, @Tag = @Tag, @ObjectID = @ObjId, @ParentObjectId = @ParentObjId, @LogType = 'SQL', @AdditionalInfo = @StepMsg, @LogId = @StepLogId OUTPUT        --Log step start
 
                --Pretend that the SQL takes 4 seconds to run
                WAITFOR DELAY '00:00:04';
                --EXEC sp_executesql @SQL
 
                EXEC EndLog @LogID = @StepLogId;    --Log step end
 
                ---------------
                ----STEP 3 ----
                ---------------
                --Unhandled error in this step
 
                SET @StepMsg = @SQL
                EXEC StartLog @DatabaseId = @DBId, @Tag = @Tag, @ObjectID = @ObjId, @LogType = 'SQL', @AdditionalInfo = @StepMsg, @LogId = @StepLogId OUTPUT        --Log step start
 
                -- RAISERROR with severity 11-19 will cause execution to jump to the CATCH block.
                RAISERROR ('Moon stuff is too complex! Giving up.', -- Message text.
                           16, -- Severity.
                           1 -- State.
                           );
 
                EXEC EndLog @LogID = @StepLogId;    --Log step end
 
                EXEC EndLog @LogID = @LogId;        --Log procedure end
 
            END TRY
            BEGIN CATCH
                --Log the error to the procedure log
                IF (@LogId IS NOT NULL)
                    EXEC EndLog @LogId = @LogId;        --Log procedure end
                IF (@StepLogId IS NOT NULL)
                    EXEC EndLog @LogId = @StepLogId;    --Log step end
 
                --Comment/uncomment the version of "Rethrow" based on the version of SQL Server you are using
 
                --Rethrow: SQL Server versions below 2012
                --Get the details of the error--that invoked the CATCH block
                DECLARE
                    @ErMessage NVARCHAR(2048),
                    @ErSeverity INT,
                    @ErState INT
                SELECT
                    @ErMessage = ERROR_MESSAGE(),
                    @ErSeverity = ERROR_SEVERITY(),
                    @ErState = ERROR_STATE();
 
                --Should be able to replace with a single THROW statement in SQL 2012
                RAISERROR (@ErMessage, @ErSeverity, @ErState );
 
                --Rethrow: SQL Server versions 2012 and above
                --THROW;
 
            END CATCH;
        END;
        GO
 
        -------------------------------------------------------------------------------------------------------------
 
        --Test call...
        EXEC #MainProc
 
        --Select from the log to show what was logged
        SELECT * FROM Log ORDER BY 1 DESC
 
        DROP PROCEDURE #LoggingTestProc;
        DROP PROCEDURE #MainProc;
 
    --++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 
    ---------------
    --Example 1
    ---------------
    --This is an example of "fire and forget" logging. We do not care about getting back to the logged entry.
        --Example 1.1 - Simplest call
        DECLARE @LogId BIGINT;
        EXEC StartLog @ObjectID = @@PROCID, @LogId = @LogId OUTPUT;
 
        --Example 1.2 - ..+ Status message is included
        DECLARE @LogId BIGINT;
        EXEC StartLog @ObjectID = @@PROCID, @AdditionalInfo = 'Some status message', @LogId = @LogId OUTPUT;
 
        --Example 1.3 - ..+ Status message + Log type is included
        DECLARE @LogId BIGINT;
        EXEC StartLog @ObjectID = @@PROCID, @LogType = 'PROCEDURE', @AdditionalInfo = 'Some status message', @LogId = @LogId OUTPUT;
 
        --Example 1.4 - ..+ ParentObjectID is included
        DECLARE @LogId BIGINT;
        DECLARE @ParentObjectId BIGINT;
 
        SET @ParentObjectId = OBJECT_ID('[CLT2EVE_Transforms].[WorkTransformExclude].[Claims_RetroReceiptChangeHistory]')
        EXEC StartLog @ObjectID = @@PROCID, @ParentObjectID = @ParentObjectId, @LogType = 'PROCEDURE', @AdditionalInfo = 'Some status message', @LogId = @LogId OUTPUT;
 
        --Example 1.4 - ..+ DatbaseID is included
        DECLARE @LogId BIGINT;
        DECLARE @DatabaseId BIGINT;
        DECLARE @ParentObjectId BIGINT;
 
        SET @DatabaseId = DB_ID()
        SET @ParentObjectId = OBJECT_ID('[CLT2EVE_Transforms].[WorkTransformExclude].[Claims_RetroReceiptChangeHistory]')
        EXEC StartLog @DatabaseId = @DatabaseId, @ObjectID = @@PROCID, @ParentObjectID = @ParentObjectId, @LogType = 'PROCEDURE', @AdditionalInfo = 'Some status message', @LogId = @LogId OUTPUT;
 
    --++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 
    ---------------
    --Example 2
    ---------------
    --In this example, we set context info once at the beginning of the session and use that to tie all log entries...
    --      This context info, could be different for the same procedure for calls made from different applications!! That is the beauty of this.
    --      The context info can also be changed mid-way through a process if that is the requirement!
 
        DECLARE @LogId BIGINT;
        DECLARE @Msg VARCHAR(255) = 'Process customer records';
        DECLARE @AppContextInfo VARBINARY(128) =  CAST('My Fancy Application' AS  VARBINARY(128))
 
        SET CONTEXT_INFO @AppContextInfo
 
        --Register start
        EXEC StartLog @ObjectID = @@PROCID, @AdditionalInfo = @Msg, @LogId = @LogId OUTPUT;     
 
        --Take a look that log entry's AppContextInfo column!
        SELECT AppContextInfo FROM Log WHERE LogId = @LogId;
 
    --++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 
    ---------------
    --Example 3
    ---------------
    --In this example, we want to track the start and end time for the procedure (using OUTPUT variable @LogId)
        DECLARE @LogId BIGINT;
        DECLARE @Msg VARCHAR(255) = 'Process customer records';
 
        --Register start
        EXEC StartLog @ObjectID = @@PROCID, @AdditionalInfo = @Msg, @LogId = @LogId OUTPUT;     
 
        --<<Make the actual call to process customer record here>>
 
        --Register end
        EXEC EndLog @LogID = @LogId;
 
        --At this point, you can select the log entry from Log
        SELECT * FROM Log WHERE LogId = @LogId;
 
    --++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 
    ---------------
    --Example 4
    ---------------
    --In this example, we want to track the start and end time for the procedure (using OUTPUT variable @LogId)
    --      + we want to track the start and end time of every step within the procedure..
 
        DECLARE @LogId BIGINT;
        DECLARE @Msg VARCHAR(255) = 'Process customer records';
 
        DECLARE @StepLogId INT;
        DECLARE @StepMsg VARCHAR(255);
 
        --Register ***procedure*** start
        EXEC StartLog @ObjectID = @@PROCID, @AdditionalInfo = @Msg, @LogId = @LogId OUTPUT;     
 
        --Register ***Step 1*** start
        SET @StepMsg = 'About to run step 1 for procedure!'
        EXEC StartLog @ObjectID = @@PROCID, @LogType = 'STEP', @AdditionalInfo = @StepMsg, @LogId = @StepLogId OUTPUT
        --Register ***Step 1*** end
        EXEC EndLog @LogId = @StepLogId;
 
        --Register ***Step 2*** start
        SET @StepMsg = 'About to run step 2 for procedure!'
        EXEC StartLog @ObjectID = @@PROCID, @LogType = 'STEP', @AdditionalInfo = @StepMsg, @LogId = @StepLogId OUTPUT
        --Register ***Step 2*** end
        EXEC EndLog @LogId = @StepLogId;
 
        --Register ***procedure*** end
        EXEC EndLog @LogID = @LogId;
 
        --At this point, you can select the log entry from Log
        SELECT * FROM Log ORDER BY 1 DESC;
 
    --++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 
    ---------------
    --Example 5
    ---------------
    --In this example, we record a lot of additional information in a structured manner (XML) in the Tag column that is queryable later
    --      Notice, how "MontlyRetroRun" is used as the root node and later query against the log table uses that
 
        DECLARE @LogId BIGINT;
        DECLARE @Msg VARCHAR(255) = 'Process customer records';
 
        DECLARE @Tag VARCHAR(512) = '<MonthlyRetroRun> ' +
                                        '<ProcessName>MonthlyRetro</ProcessName>' +
                                        '<ReportToDate><<REPORTTODATE>></ReportToDate>' +
                                        '<RetroCessionMonthlyActivityLogId><<RETROCESSIONMONTHLYACTIVITYLOGID>></RetroCessionMonthlyActivityLogId>' +
                                        '<BatchNumber><<BATCHNUMBER>></BatchNumber>' +
                                        '<RunSequenceNumber><<RUNSEQUENCENUMBER>></RunSequenceNumber>' +
                                    '</MonthlyRetroRun>';
 
        ------------------------ Begin: Tag ------------------------
        --Replace placeholders in the Tag
        SET @Tag = REPLACE(@Tag, '<<REPORTTODATE>>', CONVERT(VARCHAR,getdate()));
        SET @Tag = REPLACE(@Tag, '<<RETROCESSIONMONTHLYACTIVITYLOGID>>', 232121);
        SET @Tag = REPLACE(@Tag, '<<BATCHNUMBER>>', LTRIM(STR(11)));
        SET @Tag = REPLACE(@Tag, '<<RUNSEQUENCENUMBER>>', LTRIM(STR(99999)));
 
        SET @Msg = 'Beginning procedure!'
        EXEC StartLog @Tag = @Tag, @ObjectID = @@PROCID, @LogType = 'PROCEDURE', @AdditionalInfo = @Msg, @LogId = @LogId OUTPUT     --Log procedure start
        ------------------------ End: Tag ------------------------  
 
        --At this point, you can select the log entry from Log where
        SELECT r.value('RunSequenceNumber[1]','INT') AS RunNumber,
                r.value('ReportToDate[1]','DateTime') AS ReportToDate,
                l.*
        FROM   Log l
            CROSS APPLY Tag.nodes('/MonthlyRetroRun') AS Runs(r)
 
    --++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    ---------------
    --Example 6
    ---------------
    --In this example, we will see how to work with loops when processing large number of items without cluttering the log!
	--DO NOT do logging inside a loop like this for every loop iteration!
	--(if you do, do it after every x iterations in the loop as this example shows!)

        ------------------------ Begin: Logging related ------------------------
    DECLARE @DBId BIGINT = DB_ID();
    DECLARE @ObjId BIGINT = @@PROCID;
    DECLARE @ParentObjId BIGINT = NULL;     --Set to NULL if no @CallerProcId parameter
    DECLARE @LogId BIGINT;
    DECLARE @Msg VARCHAR(255);
    DECLARE @StepLogId BIGINT;
    DECLARE @StepMsg VARCHAR(255);
    DECLARE @Tag VARCHAR(512) = NULL;         --Set to NULL if no @CallerTag parameter
        ------------------------ End: Logging related ------------------------
 

	-------------------------------------------------------------
	SET @StepMsg = 'Loop through 100000 items';
	------------------------------------------------------------
	EXEC StartLog @DatabaseId = @DBId, @Tag = @Tag, @ObjectID = @ObjId, @ParentObjectId = @ParentObjId, @LogType = 'STEP', @AdditionalInfo = @StepMsg, @LogId = @StepLogId OUTPUT --Log step start
	
	--Create a table and insert into the table
	--------------------------------------------
	CREATE TABLE dbo.T1 (Col1 int, Col2 char(3));  	

	DECLARE @LoopLogId INT
	DECLARE @i int = 0;  
	BEGIN TRAN  

	SET @i = 0;  
	WHILE (@i < 100000)  
	BEGIN  

		--Only log every 10,000 iterations
		IF (@i % 10000) = 0
		BEGIN
			-------------------------------------------------------------
			SET @StepMsg = 'Processing ' + STR(@i) + ' of 100000 items';
			------------------------------------------------------------
	
			EXEC StartLog @DatabaseId = @DBId, @Tag = @Tag, @ObjectID = @ObjId, @ParentObjectId = @ParentObjId, @LogType = 'LOOP', @AdditionalInfo = @StepMsg, @LogId = @LoopLogId OUTPUT
		END;

		INSERT INTO dbo.T1 VALUES (@i, CAST(@i AS char(3)));  
		SET @i += 1;  

		--Close-out the loop entry so that end-time will be recorded for this iteration
		IF (@i % 10000) = 0
		BEGIN
			EXEC EndLog @LogID = @LoopLogId; --Log loop end
		END;
	END;  
	COMMIT TRAN;  

	EXEC EndLog @LogID = @LogId; --End of process

	DROP TABLE dbo.T1


	---------------
    --Example 7
    ---------------
    --In this example, we will see how to work with loops
	
        ------------------------ Begin: Logging related ------------------------
    DECLARE @DBId BIGINT = DB_ID();
    DECLARE @ObjId BIGINT = @@PROCID;
    DECLARE @ParentObjId BIGINT = NULL;     --Set to NULL if no @CallerProcId parameter
    DECLARE @LogId BIGINT;
    DECLARE @Msg VARCHAR(255);
    DECLARE @StepLogId BIGINT;
    DECLARE @StepMsg VARCHAR(255);
    DECLARE @Tag VARCHAR(512) = NULL;         --Set to NULL if no @CallerTag parameter
        ------------------------ End: Logging related ------------------------

	------------------------------------------------------------
	SET @StepMsg = 'Get the list of objects';
	------------------------------------------------------------
	EXEC StartLog @DatabaseId = @DBId, @Tag = @Tag, @ObjectID = @ObjId, @ParentObjectId = @ParentObjId, @LogType = 'STEP', @AdditionalInfo = @StepMsg, @LogId = @StepLogId OUTPUT --Log step start
 
	SELECT *
	INTO #ControlTable
	FROM sys.objects;

	------------------------------------------------------------
	SET @StepMsg = 'Loop through objects and process each';
	------------------------------------------------------------
	EXEC StartLog @DatabaseId = @DBId, @Tag = @Tag, @ObjectID = @ObjId, @ParentObjectId = @ParentObjId, @LogType = 'STEP', @AdditionalInfo = @StepMsg, @LogId = @StepLogId OUTPUT --Log step start
 
	DECLARE @object_id BIGINT = NULL;
	DECLARE @LoopLogId INT = 0;
	
	WHILE EXISTS (SELECT 1 FROM #ControlTable)
	BEGIN
 
		SELECT TOP 1
			@object_id = object_id
		FROM #ControlTable
		ORDER BY Object_Id asc;
 
		------------------------------------------------------------
		SET @StepMsg = 'Process object_id: ' + STR(@object_id);
		------------------------------------------------------------
		EXEC StartLog @DatabaseId = @DBId, @Tag = @Tag, @ObjectID = @ObjId, @ParentObjectId = @ParentObjId, @LogType = 'LOOP', @AdditionalInfo = @StepMsg, @LogId = @LoopLogId OUTPUT --Log step start
 
		PRINT 'Working with object'
 
		EXEC EndLog @LogID = @LoopLogId; --Log loop end

		DELETE FROM #ControlTable
		WHERE object_id = @object_id
	END;

	DROP TABLE #ControlTable

    -------------------------------------------
    --Examples that illustrate working with XML
    -------------------------------------------
 
    --Example 1
    -- Querying XML data column "Tag"
        --If Log.Tag column has the value "<MonthlyRetroRun RunId="1">Test</MonthlyRetroRun>", one could query like this.
        -- Reference: http://thegrayzone.co.uk/blog/2010/03/querying-sql-server-xml-data/
        SELECT r.value('MonthlyRetroRun[1]','varchar(15)')
        FROM   Log
        CROSS APPLY Tag.nodes('/') AS Runs(r)
 
    --Example 2
    -- Somewhat more complex querying of XML data column "Tag"
        UPDATE Log
        SET Tag = '<MonthlyRetroRun ReportToDate="' + CONVERT(VARCHAR(25), CONVERT(datetime, '2014-02-28 00:00:00.000')) + '"> ' +
                                        '<ReportToDate>' + CONVERT(VARCHAR(25), CONVERT(datetime, '2014-02-28 00:00:00.000')) + '</ReportToDate>' +
                                        '<RunNumber>1</RunNumber>' +
                                        '<BatchSize>' + LTRIM(STR(1000)) + '</BatchSize>' +
                                        '<MaxRecords>' + LTRIM(STR(50000)) + '</MaxRecords>' +
                                    '</MonthlyRetroRun>'
        WHERE LogId = 4                         
 
        SELECT r.value('RunNumber[1]','INT') AS RunNumber,
                r.value('ReportToDate[1]','DateTime') AS ReportToDate
        FROM   Log
            CROSS APPLY Tag.nodes('/MonthlyRetroRun') AS Runs(r)
        WHERE LogId = 4                         
 
    --++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 
*/
	BEGIN TRY
		DECLARE @StepMsg VARCHAR(255);

		-------------------------------------------------------------
		SET @StepMsg = 'Getting LOG settings';
		------------------------------------------------------------
		
		DECLARE @AppSetting_AppContextInfo		VARCHAR(128);
		DECLARE @AppSetting_IsOn				BIT = 0;
		DECLARE @AppSetting_LogAutonomously		BIT = 1;
		DECLARE @AppSetting_InferTag			BIT = 1;
		DECLARE @AppSetting_InferParentObjectId BIT = 1;
		DECLARE @AppSetting_InferLastSQL		BIT = 0;
		DECLARE @AppSetting_InferError			BIT = 1;
		DECLARE @AppSetting_PrintMessages		BIT = 1;

		--Remove the null byte padding!
		--https://stackoverflow.com/questions/9434662/casting-context-info-to-varchar-and-the-resulting-length
		SELECT @AppSetting_AppContextInfo = REPLACE(CAST(COALESCE(@ContextInfo, CONTEXT_INFO()) AS VARCHAR(128)) COLLATE Latin1_General_100_BIN , 
													0x00, 
													'')

		IF NOT EXISTS(SELECT 1 
					FROM Logging.LogAppMaster
					WHERE AppContextInfo = @AppSetting_AppContextInfo
					)
		BEGIN

			--Use the setting from [DEFAULT] if AppContextInfo does not exist!
			IF EXISTS(SELECT 1 
					FROM Logging.LogAppMaster
					WHERE AppContextInfo = '[DEFAULT]'
					)
			BEGIN
				SET @AppSetting_AppContextInfo = '[DEFAULT]';
			END;
			ELSE
			BEGIN
				SET @AppSetting_AppContextInfo = NULL;
			END;
		END;

		--Priority order - 1) AppContextInfo specific settings 2) [DEFAULT] settings 3) Code settings above if #1 and #2 are missing
		IF (@AppSetting_AppContextInfo IS NOT NULL)
			SELECT
				@AppSetting_IsOn				= IsOn,
				@AppSetting_LogAutonomously		= LogAutonomously,
				@AppSetting_InferTag			= InferTag,
				@AppSetting_InferParentObjectId = InferParentObjectId,
				@AppSetting_InferLastSQL		= InferLastSQL,
				@AppSetting_InferError			= InferError,
				@AppSetting_PrintMessages		= PrintMessages
			FROM
				Logging.LogAppMaster
			WHERE 
				AppContextInfo = @AppSetting_AppContextInfo


		-------------------------------------------------------------
		SET @StepMsg = 'Initializing variables';
		------------------------------------------------------------
	
		-- ================================================================================================
		DECLARE @NewServerName		VARCHAR(100) = COALESCE(@ServerName, @@SERVERNAME)
		DECLARE @NewSPID			INT = COALESCE(@SPID, @@SPID)
		--Connection_Id uniquely identifies a connection like SID+Serial# in Oracle.
		--  This can be used to detect active sessions based on entries in the log table (and possibly kill if needed).
		DECLARE @NewConnectionId	UNIQUEIDENTIFIER = (
														SELECT COALESCE(@ConnectionId, Connection_Id)
														FROM sys.dm_exec_connections
														WHERE session_id = @NewSPID
													);
		DECLARE @NewDatabaseID		BIGINT = COALESCE(@DatabaseId, DB_ID());	
		DECLARE @NewDBName			VARCHAR(100) = DB_NAME(@NewDatabaseID);
		DECLARE @NewContextInfo		VARBINARY(128) = COALESCE(@ContextInfo, CONTEXT_INFO());	--See http://www.sqlservercentral.com/articles/T-SQL/2765/ for more information on how this is used!
		DECLARE @NewTag				VARCHAR(MAX) = @Tag;										--XML not supported on linked server!
		DECLARE @NewObjectName		NVARCHAR(256) = @ObjectName;	
		DECLARE @NewParentObjectId	BIGINT = @ParentObjectId;
		DECLARE @NewParentObjectName NVARCHAR(256) = @ParentObjectName;
		DECLARE @NewErrorLine		INT = @ErrorLine;
		DECLARE @NewErrorMessage	NVARCHAR(4000) = @ErrorMessage;
		DECLARE @NewTranCount		INT = COALESCE(@TranCount, @@TRANCOUNT);
		DECLARE @NewLastSQL			VARCHAR(MAX) = @LastSQL;
 	
		DECLARE @ReturnLogId		INT = 0;
	
		-------------------------------------------------------------
		SET @StepMsg = 'Fetching defaults for parameters';
		------------------------------------------------------------
		IF (@AppSetting_IsOn = 1) 
		BEGIN

			IF (@IsLoopback = 0)
			BEGIN

				-------------------------------------------------------------
				SET @StepMsg = 'Fetching LastSQL using DBCC INPUTBUFFER';
				------------------------------------------------------------			
				IF (@AppSetting_InferLastSQL = 1)
				BEGIN
					IF (@NewLastSQL IS NULL)
					BEGIN
						--Create a global temporary table to hold DBCC InputBuffer output
						-- (creating as global one-time to avoid incurring the table creation cost everytime a log entry is made)
						IF OBJECT_ID('tempdb..##Inputbuffer') IS NULL
							CREATE TABLE ##Inputbuffer(
								EventType NVARCHAR(30) NULL,
								Parameters INT NULL,
								EventInfo NVARCHAR(MAX) NULL
							);
						ELSE
							--Clear off stale data if any!
							TRUNCATE TABLE ##InputBuffer;

						--Record the last SQL statement
						INSERT ##Inputbuffer
						EXEC('DBCC INPUTBUFFER(@@SPID) WITH NO_INFOMSGS');

						SELECT TOP 1 @NewLastSQL = EventInfo
						FROM ##Inputbuffer;
					END;
				END;
	

				-------------------------------------------------------------
				SET @StepMsg = 'Derive the object name';
				------------------------------------------------------------			
				-- ..as object ids get changed if objects are recreated and hence logs become useless
			
				IF (@NewObjectName IS NULL)
				BEGIN
					IF (@ObjectID IS NOT NULL)
					BEGIN
						--If ObjectId is less than zero, it is a temporary object that exists in tempdb!
						IF @ObjectID < 0
						BEGIN 
							SET @NewObjectName = COALESCE('tempdb'
															+ '.' + QUOTENAME(OBJECT_SCHEMA_NAME(@ObjectID, db_id('tempdb')))
															+ '.' + QUOTENAME(OBJECT_NAME(@ObjectID, db_id('tempdb')))
														, ERROR_PROCEDURE());
						END;
						ELSE
						BEGIN
							SET @NewObjectName = COALESCE(QUOTENAME(DB_NAME(@NewDatabaseID))
															+ '.' + QUOTENAME(OBJECT_SCHEMA_NAME(@ObjectID, @NewDatabaseID))
															+ '.' + QUOTENAME(OBJECT_NAME(@ObjectID, @NewDatabaseID))
														, ERROR_PROCEDURE());
						END;
					END;
				END;

				-------------------------------------------------------------
				SET @StepMsg = 'Use the Tag stored globally if an empty tag is passed in';
				------------------------------------------------------------			
 				IF (@AppSetting_InferTag = 1)
				BEGIN
					IF (@NewTag IS NULL)
					BEGIN
						DECLARE @TempTag SQL_VARIANT = NULL;
						EXEC GetAttribute @AttributeName='Log.Tag', @AttributeValue=@TempTag OUTPUT, @AttributeType=NULL, @AttributeFormat=NULL, @IgnoreIfAttributeIsMissing=1;
 
						SET @NewTag = CONVERT(VARCHAR(MAX), @TempTag);
					END;
				END;
 
 				-------------------------------------------------------------
				SET @StepMsg = 'Use the ParentObjectId stored globally if an empty tag is passed in';
				------------------------------------------------------------			
				IF (@NewParentObjectName IS NULL)
				BEGIN
					IF ( @NewParentObjectId IS NULL)
					BEGIN
						IF (@AppSetting_InferParentObjectId = 1)
						BEGIN
							DECLARE @TempParentObjectId SQL_VARIANT = NULL;
							EXEC GetAttribute @AttributeName='Log.ParentObjectId', @AttributeValue=@TempParentObjectId OUTPUT, @AttributeType=NULL, @AttributeFormat=NULL, @IgnoreIfAttributeIsMissing=1;
 
							SET @NewParentObjectId = CONVERT(BIGINT, @TempParentObjectId);
						END;
					END;

					IF ( @NewParentObjectId IS NOT NULL)
					BEGIN
						--If ObjectId is less than zero, it is a temporary object that exists in tempdb!
						IF @NewParentObjectId < 0
						BEGIN 
							SET @NewParentObjectName = COALESCE('tempdb'
														+ '.' + QUOTENAME(OBJECT_SCHEMA_NAME(@NewParentObjectId, db_id('tempdb')))
														+ '.' + QUOTENAME(OBJECT_NAME(@NewParentObjectId, db_id('tempdb')))
												, ERROR_PROCEDURE());
						END;
						ELSE
						BEGIN
							SET @NewParentObjectName = COALESCE(QUOTENAME(DB_NAME(@NewDatabaseID))
														+ '.' + QUOTENAME(OBJECT_SCHEMA_NAME(@NewParentObjectId, @NewDatabaseID))
														+ '.' + QUOTENAME(OBJECT_NAME(@NewParentObjectId, @NewDatabaseID))
												, ERROR_PROCEDURE());
						END;

					END;
				END;
 
			

 				-------------------------------------------------------------
				SET @StepMsg = 'Infer error if needed!';
				------------------------------------------------------------			
				IF (@AppSetting_InferError = 1)
				BEGIN
					SET @NewErrorLine = COALESCE(@ErrorLine, ERROR_LINE());
					SET @NewErrorMessage = COALESCE(@ErrorMessage, ERROR_MESSAGE());
				END;

			END;


			-------------------------------------------------------------
			SET @StepMsg = 'Log to table (if not inside a transaction (or) if looping back (or) not logging autonomously)';
			------------------------------------------------------------						
			IF (
					--If nested transaction but we should not log autonomously (i.e., logging is transactional too)
					((@NewTranCount > 0) AND (@AppSetting_LogAutonomously = 0))
					OR
					--If not a nested transaction we dont care about logging autonomously
					(@NewTranCount = 0)
					OR
					--If we are looping back, we need to do this INSERT ..but at that point we will be on a separate connection!
					(@IsLoopback = 1)
				)
			BEGIN
				--Create a new entry in the log table
				INSERT Log (
					ServerName
					,SPID
					,ConnectionId
					,DatabaseName
					,AppContextInfo
					,Tag
					,ObjectID
					,ParentObjectID
					,LogType
					,ObjectName
					,ParentObjectName
					,EndDateTime
					,RowsAffected
					,ErrorLine
					,ErrorMessage
					,AdditionalInfo
					,TransactionCount
					,LastSQL
					)
				SELECT @NewServerName
					,@NewSPID
					,@NewConnectionId
					,@NewDBName
					,@NewContextInfo
					,@NewTag
					,@ObjectID
					,@NewParentObjectID
					,@LogType
					,@NewObjectName
					,@NewParentObjectName
					,NULL
					,@RowsAffected      --Caution on what you pass in for @RowsAffected. You do not want to record rowcount for previous operation (using @@ROWCOUNT) rather than the one currenly being logged
					,@NewErrorLine
					,@NewErrorMessage
					,@AdditionalInfo
					,@NewTranCount
					,@NewLastSQL;

				SET @ReturnLogId = @@IDENTITY;
			END
	
			-------------------------------------------------------------
			SET @StepMsg = 'Loopback - if (we are not already on a loopback and logging autonomously)!';
			------------------------------------------------------------						
			IF (
					((@NewTranCount > 0) AND (@AppSetting_LogAutonomously = 1))
					AND 
					(@IsLoopback = 0)				
				)
			BEGIN
		
				EXEC loopback.Util.Logging.StartLog 
					@ServerName = @NewServerName
					,@SPID = @NewSPID
					,@ConnectionId = @NewConnectionId
					,@DatabaseId = @NewDatabaseID
					,@ContextInfo = @NewContextInfo
					,@Tag = @NewTag					--XML not supported in Linked Servers
					,@ObjectId = @ObjectID
					,@ParentObjectId = @NewParentObjectID
					,@LogType = @LogType
					,@ObjectName = @NewObjectName
					,@ParentObjectName = @NewParentObjectName
					,@RowsAffected = @RowsAffected
					,@LogID = @ReturnLogID OUTPUT
					,@AdditionalInfo = @AdditionalInfo
					--We do not want to recursively keep inserting and need a way to know if it was loopback so that we insert just once.
					,@IsLoopback = 1
					,@ErrorLine = @NewErrorLine
					,@ErrorMessage = @NewErrorMessage			
					,@TranCount = @NewTranCount
					,@LastSQL = @NewLastSQL;		
			END;
 
			--Set the OUTPUT parameter @LogId
			SET @LogID = @ReturnLogID; 

			IF (@AppSetting_PrintMessages = 1)
			BEGIN
				PRINT CONVERT(VARCHAR, GETDATE()) + ': ' + LTRIM(STR(@LogID)) + ' - ' + COALESCE(@NewObjectName,'[NONE]') + ' - ' + COALESCE(@AdditionalInfo,'[N/A]');
			END;

		END; --IF (@AppSetting_IsOn = 1) 

	END TRY
	BEGIN CATCH
		--Add a clue about where the error happened to the message before raising!
		DECLARE @ErMessage NVARCHAR(4000),
				@ErSeverity INT, 
				@ErState INT;  
  
		SET @ErMessage = 'StartLog: Error when running step: ' + @StepMsg + ' - ' + ERROR_MESSAGE();
		SET @ErSeverity = ERROR_SEVERITY();
		SET @ErState = ERROR_STATE(); 

        RAISERROR (@ErMessage, @ErSeverity, @ErState );

	END CATCH;

END;
GO
PRINT N'Creating [Logging].[EndLog]...';


GO
CREATE PROCEDURE [Logging].[EndLog]
	 @LogID         BIGINT
	,@RowsAffected  INT = NULL
	,@ErrorLine		INT = NULL
	,@ErrorMessage	NVARCHAR(4000) = NULL
AS
BEGIN
 
-- =============================================================================================
-- Original:    Original idea from Aaron Bertrand
-- Created By: Jana Sattainathan
--              Apr 07, 2014 - Created this procedure that will help track duration of activities (by closing an open log entry)
-- Source:  http://www.mssqltips.com/sqlservertip/2003/simple-process-to-track-and-log-sql-server-stored-procedure-use/
-- Create date: Apr 06, 2014
-- Description: Procedure that ends an open log entry in ProcedureLog table
-- Usage:
/*
    --Example 1
        DECLARE @LogId INT;
        DECLARE @Tag XML = '<MonthlyRetroRun RunId="1">Test</MonthlyRetroRun>';
        DECLARE @Msg VARCHAR(255) = 'Process customer records';
        EXEC StartLog @Tag = @Tag, @ObjectID = @@PROCID, @AdditionalInfo = @Msg, @LogId = @LogId OUTPUT;
        EXEC EndLog @LogID = @LogId;
 
        SELECT * FROM Log
 
*/
-- Reference:
--  Working with XML - http://technet.microsoft.com/en-us/library/bb522510.aspx
--
-- ================================================================================================
    DECLARE @NewRowsAffected INT = COALESCE(@RowsAffected, @@ROWCOUNT);
	DECLARE @NewEndDateTime DATETIME = GETDATE();
	DECLARE @NewErrorLine INT = @ErrorLine;
	DECLARE @NewErrorMessage NVARCHAR(4000) = @ErrorMessage;

	BEGIN TRY
		DECLARE @StepMsg VARCHAR(255);

		--If the @LogID is NULL or zero, dont do anything!
		IF COALESCE(@LogID, 0) > 0 
		BEGIN
			-------------------------------------------------------------
			SET @StepMsg = 'Getting LOG settings';
			------------------------------------------------------------
			DECLARE @AppSetting_AppContextInfo		VARCHAR(128) = CONTEXT_INFO();
			DECLARE @AppSetting_IsOn				BIT = 1;
			DECLARE @AppSetting_LogAutonomously		BIT = 1;
			DECLARE @AppSetting_InferTag			BIT = 1;
			DECLARE @AppSetting_InferParentObjectId BIT = 1;
			DECLARE @AppSetting_InferLastSQL		BIT = 0;
			DECLARE @AppSetting_InferError			BIT = 1;
			DECLARE @AppSetting_PrintMessages		BIT = 1;

			IF NOT EXISTS(SELECT 1 
						FROM Logging.LogAppMaster
						WHERE AppContextInfo = @AppSetting_AppContextInfo
						)
			BEGIN
				--Use the setting from [DEFAULT] if AppContextInfo does not exist!
				IF EXISTS(SELECT 1 
						FROM Logging.LogAppMaster
						WHERE AppContextInfo = '[DEFAULT]'
						)
				BEGIN
					SET @AppSetting_AppContextInfo = '[DEFAULT]';
				END;
				ELSE
				BEGIN
					SET @AppSetting_AppContextInfo = NULL;
				END;
			END;

			--Priority order - 1) AppContextInfo specific settings 2) [DEFAULT] settings 3) Code settings above if #1 and #2 are missing
			IF (@AppSetting_AppContextInfo IS NOT NULL)
				SELECT
					@AppSetting_IsOn				= IsOn,
					@AppSetting_LogAutonomously		= LogAutonomously,
					@AppSetting_InferTag			= InferTag,
					@AppSetting_InferParentObjectId = InferParentObjectId,
					@AppSetting_InferLastSQL		= InferLastSQL,
					@AppSetting_InferError			= InferError,
					@AppSetting_PrintMessages		= PrintMessages
				FROM
					Logging.LogAppMaster
				WHERE 
					AppContextInfo = @AppSetting_AppContextInfo;
				

			IF (@AppSetting_IsOn = 1) 
			BEGIN
				-------------------------------------------------------------
				SET @StepMsg = 'Infer error if needed!';
				------------------------------------------------------------			
				IF (@AppSetting_InferError = 1)
				BEGIN
					SET @NewErrorLine = COALESCE(@ErrorLine, ERROR_LINE());
					SET @NewErrorMessage = COALESCE(@ErrorMessage, ERROR_MESSAGE());
				END;
								

				-------------------------------------------------------------
				SET @StepMsg = 'Close out log entry';
				------------------------------------------------------------								
				IF (@AppSetting_LogAutonomously = 0)
				BEGIN
					UPDATE Logging.Log
					SET EndDateTime = @NewEndDateTime, --DATEDIFF(S, LogDate, GETDATE()),
						RowsAffected = @NewRowsAffected,
						ErrorLine = @NewErrorLine,
						ErrorMessage = @NewErrorMessage
					WHERE LogId = @LogID;
 			
				END;
				ELSE
				BEGIN
					EXEC ('UPDATE Util.Logging.Log
							SET EndDateTime = ?,
								RowsAffected = ?,
								ErrorLine = ?,
								ErrorMessage = ?
							WHERE LogId = ?', @NewEndDateTime, @NewRowsAffected, @NewErrorLine, @NewErrorMessage, @LogID) AT [LOOPBACK];

				END;

				-------------------------------------------------------------
				SET @StepMsg = 'Pring log entry close';
				------------------------------------------------------------	

				IF (@AppSetting_PrintMessages = 1)
				BEGIN
					PRINT CONVERT(VARCHAR,GETDATE()) + ': ' + LTRIM(STR(@LogID)) + ' - Call ended';
				END;

			END;		--IF (@AppSetting_IsOn = 1) 
		END;	--IF COALESCE(@LogID, 0) > 0 

	END TRY
	BEGIN CATCH
		--Add a clue about where the error happened to the message before raising!
		DECLARE @ErMessage NVARCHAR(4000),
				@ErSeverity INT, 
				@ErState INT;  
  
		SET @ErMessage = 'EndLog: Error when running step: ' + @StepMsg + ' - ' + ERROR_MESSAGE();
		SET @ErSeverity = ERROR_SEVERITY();
		SET @ErState = ERROR_STATE(); 

        RAISERROR (@ErMessage, @ErSeverity, @ErState );
	END CATCH;
	
END;
GO


USE Util
GO
--------------------------------------------------------
--Default seed values for [Logging].[LogAppMaster]
--------------------------------------------------------
INSERT INTO [Logging].[LogAppMaster] ([AppContextInfo], [IsOn], [LogAutonomously], [InferTag], [InferParentObjectId], [InferLastSQL], [InferError], [PrintMessages]) 
VALUES (N'[DEFAULT]', 1, 1, 1, 1, 0, 1, 0);


----------------------------
--Linked server to loopback
----------------------------

EXEC sp_addlinkedserver @server = N'loopback',@srvproduct = N' ',@provider = N'SQLNCLI', @datasrc = @@SERVERNAME

GO

EXEC sp_serveroption loopback,N'remote proc transaction promotion','FALSE'

GO

EXEC sp_serveroption loopback,N'RPC OUT','TRUE' --Enable RPC to the given server.
GO

